<!-- Monitoring.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ü–µ–Ω–æ–∫</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            color: black;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .filter-container {
            margin-bottom: 20px;
        }
        button {
            background-color: #ff9800;
            border: none;
            padding: 10px 20px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover {
            background-color: #e68900;
        }
        input[type="date"] {
            padding: 5px;
            font-size: 16px;
            border-radius: 5px;
            border: none;
        }
    </style>
    <script>
        // –í—Å—Ç–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π URL Google Apps Script API
        const scriptURL = "https://script.google.com/macros/s/AKfycbwdPoRdKyUXA9h0_fOQO1vJE7kmZ1YMzqC5BkCc6oVdvTooaIc7p5sZhjTY_YBXJO3FKg/exec";

        function loadRatings() {
            let ratings = JSON.parse(localStorage.getItem('ratings')) || [];
            let tableBody = document.getElementById('ratingsTableBody');
            tableBody.innerHTML = '';
            
            ratings.forEach((entry, index) => {
                let row = `<tr>
                    <td>${index + 1}</td>
                    <td>${entry.rating}</td>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
            updateCounts();
        }

        function filterRatings() {
            let selectedDate = document.getElementById('dateFilter').value;
            let ratings = JSON.parse(localStorage.getItem('ratings')) || [];
            let tableBody = document.getElementById('ratingsTableBody');
            tableBody.innerHTML = '';

            ratings.forEach((entry, index) => {
                let entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                if (!selectedDate || entryDate === selectedDate) {
                    let row = `<tr>
                        <td>${index + 1}</td>
                        <td>${entry.rating}</td>
                        <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                }
            });
            updateCounts();
        }

        function updateCounts() {
            let ratings = JSON.parse(localStorage.getItem('ratings')) || [];
            let counts = { '–û—Ç–ª–∏—á–Ω–æ': 0, '–•–æ—Ä–æ—à–æ': 0, '–ù–æ—Ä–º–∞–ª—å–Ω–æ': 0, '–ü–ª–æ—Ö–æ': 0, '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ': 0 };
            ratings.forEach(entry => {
                if (counts.hasOwnProperty(entry.rating)) {
                    counts[entry.rating]++;
                }
            });
            
            document.getElementById('excellentCount').innerText = counts['–û—Ç–ª–∏—á–Ω–æ'];
            document.getElementById('goodCount').innerText = counts['–•–æ—Ä–æ—à–æ'];
            document.getElementById('normalCount').innerText = counts['–ù–æ—Ä–º–∞–ª—å–Ω–æ'];
            document.getElementById('badCount').innerText = counts['–ü–ª–æ—Ö–æ'];
            document.getElementById('veryBadCount').innerText = counts['–û—á–µ–Ω—å –ø–ª–æ—Ö–æ'];
        }

        function exportXLSX() {
            let ratings = JSON.parse(localStorage.getItem('ratings')) || [];
            let data = [["–û—Ü–µ–Ω–∫–∞", "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è"]];
            
            ratings.forEach(e => {
                data.push([e.rating, new Date(e.timestamp).toLocaleString()]);
            });

            let ws = XLSX.utils.aoa_to_sheet(data);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "–û—Ü–µ–Ω–∫–∏");

            XLSX.writeFile(wb, "ratings_report.xlsx");
        }

        function exportOnline() {
            let ratings = JSON.parse(localStorage.getItem('ratings')) || [];

            if (ratings.length === 0) {
                alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏!");
                return;
            }

            fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(ratings)
            })
            .then(response => response.text())
            .then(data => {
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤ Google –¢–∞–±–ª–∏—Ü—É!");
                console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
            })
            .catch(error => {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö!");
                console.error("–û—à–∏–±–∫–∞:", error);
            });
        }

        function clearRatings() {
            localStorage.removeItem('ratings');
            loadRatings();
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body onload="loadRatings()">
    <h1>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ü–µ–Ω–æ–∫</h1>
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h2>
    <p>üòä –û—Ç–ª–∏—á–Ω–æ: <span id="excellentCount">0</span></p>
    <p>üôÇ –•–æ—Ä–æ—à–æ: <span id="goodCount">0</span></p>
    <p>üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ: <span id="normalCount">0</span></p>
    <p>‚òπÔ∏è –ü–ª–æ—Ö–æ: <span id="badCount">0</span></p>
    <p>üò° –û—á–µ–Ω—å –ø–ª–æ—Ö–æ: <span id="veryBadCount">0</span></p>
    <div class="filter-container">
        <label for="dateFilter">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ: </label>
        <input type="date" id="dateFilter" onchange="filterRatings()">
        <button onclick="loadRatings()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button onclick="clearRatings()">–û—á–∏—Å—Ç–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
        <button onclick="exportXLSX()">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        <button onclick="exportOnline()">–í—ã–≥—Ä—É–∑–∫–∞ –æ–Ω–ª–∞–π–Ω</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>–û—Ü–µ–Ω–∫–∞</th>
                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
            </tr>
        </thead>
        <tbody id="ratingsTableBody"></tbody>
    </table>
</body>
</html>
